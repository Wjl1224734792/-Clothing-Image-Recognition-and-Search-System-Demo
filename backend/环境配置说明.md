# 🔧 环境配置说明

## 📋 概述

本文档详细说明了智能图片搜索系统后端的环境配置选项，包括开发环境、生产环境的配置建议。

## 🚀 快速开始

### 1. 复制环境配置文件

```bash
# 复制环境配置模板
cp env.example .env

# 编辑环境配置
nano .env
```

### 2. 基本配置

对于本地开发，使用默认配置即可：

```bash
# 使用默认配置启动
npm run dev
```

## 📝 配置项说明

### 🖥️ 服务器配置

| 配置项 | 环境变量 | 默认值 | 说明 |
|--------|----------|--------|------|
| 端口 | `PORT` | `3001` | 服务器监听端口 |
| 环境 | `NODE_ENV` | `development` | 运行环境 |
| 主机 | `HOST` | `localhost` | 服务器主机地址 |

### 🗄️ Milvus数据库配置

| 配置项 | 环境变量 | 默认值 | 说明 |
|--------|----------|--------|------|
| 主机地址 | `MILVUS_HOST` | `localhost` | Milvus服务器地址 |
| 端口 | `MILVUS_PORT` | `19530` | Milvus服务器端口 |
| SSL连接 | `MILVUS_SSL` | `false` | 是否使用SSL |
| 管理员用户 | `MILVUS_ADMIN_USER` | `root` | 超级管理员用户名 |
| 管理员密码 | `MILVUS_ADMIN_PASSWORD` | `Milvus` | 超级管理员密码 |

### 📁 文件上传配置

| 配置项 | 环境变量 | 默认值 | 说明 |
|--------|----------|--------|------|
| 存储目录 | `UPLOAD_DIR` | `./uploads` | 文件存储目录 |
| 最大文件大小 | `MAX_FILE_SIZE` | `10485760` | 单文件最大大小(字节) |
| 允许扩展名 | `ALLOWED_EXTENSIONS` | `jpg,jpeg,png,gif,webp` | 允许的文件类型 |
| 最大文件数 | `MAX_FILES` | `10` | 最大上传文件数量 |

### 🤖 AI模型配置

| 配置项 | 环境变量 | 默认值 | 说明 |
|--------|----------|--------|------|
| 缓存目录 | `MODEL_CACHE_DIR` | `./.cache` | 模型缓存目录 |
| 模型名称 | `MODEL_NAME` | `Marqo/marqo-fashionSigLIP` | AI模型名称 |
| 向量维度 | `VECTOR_DIMENSION` | `768` | 特征向量维度 |

### 🔍 向量数据库配置

| 配置项 | 环境变量 | 默认值 | 说明 |
|--------|----------|--------|------|
| 集合名称 | `COLLECTION_NAME` | `fashion_images` | Milvus集合名称 |
| 索引类型 | `INDEX_TYPE` | `HNSW` | 向量索引类型 |
| 距离度量 | `METRIC_TYPE` | `L2` | 距离计算方法 |
| HNSW参数M | `HNSW_M` | `16` | 每个节点的最大连接数 |
| HNSW参数ef | `HNSW_EF_CONSTRUCTION` | `200` | 构建时的搜索范围 |

### 📊 日志配置

| 配置项 | 环境变量 | 默认值 | 说明 |
|--------|----------|--------|------|
| 日志级别 | `LOG_LEVEL` | `info` | 日志输出级别 |
| 详细日志 | `VERBOSE_LOGGING` | `false` | 是否启用详细日志 |

### 📂 临时文件配置

| 配置项 | 环境变量 | 默认值 | 说明 |
|--------|----------|--------|------|
| 临时目录 | `TEMP_DIR` | `./temp` | 临时文件存储目录 |
| 最大存活时间 | `TEMP_MAX_AGE` | `3600000` | 临时文件最大存活时间(毫秒) |

### 🔒 安全配置

| 配置项 | 环境变量 | 默认值 | 说明 |
|--------|----------|--------|------|
| JWT密钥 | `JWT_SECRET` | `your_jwt_secret_key_here` | JWT认证密钥 |
| CORS源 | `CORS_ORIGIN` | `http://localhost:5173` | 允许的跨域源 |

### ⚡ 性能配置

| 配置项 | 环境变量 | 默认值 | 说明 |
|--------|----------|--------|------|
| 连接超时 | `CONNECTION_TIMEOUT` | `10000` | 连接超时时间(毫秒) |
| 请求超时 | `REQUEST_TIMEOUT` | `30000` | 请求超时时间(毫秒) |
| 最大并发 | `MAX_CONCURRENT_REQUESTS` | `100` | 最大并发请求数 |

### 🛠️ 开发配置

| 配置项 | 环境变量 | 默认值 | 说明 |
|--------|----------|--------|------|
| 热重载 | `HOT_RELOAD` | `true` | 是否启用热重载 |
| 调试模式 | `DEBUG_MODE` | `true` | 是否启用调试模式 |
| API文档 | `ENABLE_API_DOCS` | `true` | 是否启用API文档 |

## 🌍 环境配置示例

### 开发环境配置

```env
# 开发环境配置
NODE_ENV=development
PORT=3001
LOG_LEVEL=debug
DEBUG_MODE=true
VERBOSE_LOGGING=true
HOT_RELOAD=true
```

### 生产环境配置

```env
# 生产环境配置
NODE_ENV=production
PORT=3001
LOG_LEVEL=warn
DEBUG_MODE=false
VERBOSE_LOGGING=false
HOT_RELOAD=false

# 生产环境数据库
MILVUS_HOST=your_production_milvus_host
MILVUS_SSL=true
MILVUS_ADMIN_USER=your_production_admin
MILVUS_ADMIN_PASSWORD=your_secure_password

# 生产环境安全
JWT_SECRET=your_very_secure_jwt_secret_key
CORS_ORIGIN=https://yourdomain.com
```

### 测试环境配置

```env
# 测试环境配置
NODE_ENV=test
PORT=3002
LOG_LEVEL=error
DEBUG_MODE=false
VERBOSE_LOGGING=false
```

## 🔧 配置优化建议

### 性能优化

1. **向量索引优化**
   ```env
   # 高精度搜索
   INDEX_TYPE=HNSW
   HNSW_M=32
   HNSW_EF_CONSTRUCTION=400
   
   # 快速搜索
   INDEX_TYPE=IVF_FLAT
   ```

2. **并发优化**
   ```env
   # 高并发配置
   MAX_CONCURRENT_REQUESTS=500
   REQUEST_TIMEOUT=60000
   ```

### 安全优化

1. **生产环境安全**
   ```env
   # 强密码
   MILVUS_ADMIN_PASSWORD=your_very_secure_password_here
   JWT_SECRET=your_very_secure_jwt_secret_key_here
   
   # 限制CORS
   CORS_ORIGIN=https://yourdomain.com
   ```

2. **文件上传安全**
   ```env
   # 限制文件大小
   MAX_FILE_SIZE=5242880  # 5MB
   
   # 限制文件类型
   ALLOWED_EXTENSIONS=jpg,jpeg,png
   ```

## 🚨 常见问题

### 1. Milvus连接失败

**问题**: 无法连接到Milvus数据库

**解决方案**:
```bash
# 检查Milvus服务状态
docker-compose ps

# 检查Milvus配置
echo $MILVUS_HOST
echo $MILVUS_PORT
```

### 2. 文件上传失败

**问题**: 文件上传时出现错误

**解决方案**:
```bash
# 检查上传目录权限
ls -la uploads/

# 检查文件大小限制
echo $MAX_FILE_SIZE
```

### 3. 模型加载失败

**问题**: AI模型无法加载

**解决方案**:
```bash
# 检查模型缓存目录
ls -la .cache/

# 检查网络连接
ping huggingface.co
```

## 📚 相关文档

- [后端README文档](./README.md)
- [API接口文档](./API-文档.md)
- [MVC架构说明](./服务端开发规范.md)
