# ğŸŒŸæœåŠ¡ç«¯ MVC å¼€å‘è§„èŒƒ

## 1. æ¶æ„è®¾è®¡è§„èŒƒ

### 1.1 MVC åˆ†å±‚æ¶æ„

```
src/
â”œâ”€â”€ controllers/           // æ§åˆ¶å™¨å±‚
â”œâ”€â”€ services/             // æœåŠ¡å±‚
â”œâ”€â”€ models/              // æ¨¡å‹å±‚
â”œâ”€â”€ repositories/        // æ•°æ®è®¿é—®å±‚
â”œâ”€â”€ middlewares/         // ä¸­é—´ä»¶å±‚
â”œâ”€â”€ routers/             // è·¯ç”±å±‚
â”œâ”€â”€ types/               // ç±»å‹å®šä¹‰
â”œâ”€â”€ enums/               // æšä¸¾å®šä¹‰
â”œâ”€â”€ utils/               // å·¥å…·å‡½æ•°
â”œâ”€â”€ config/              // é…ç½®ç®¡ç†
â””â”€â”€ validators/          // éªŒè¯å™¨
```

### 1.2 ä¾èµ–æµå‘åŸåˆ™
```
Controller â†’ Service â†’ Repository â†’ Model
     â†“
Middleware â†’ Validator â†’ Utils
```

## 2. æ–‡ä»¶å‘½åè§„èŒƒ

### 2.1 ç›®å½•å‘½å
- ä½¿ç”¨**å¤æ•°å½¢å¼** + **å°å†™çŸ­æ¨ªçº¿**
```typescript
users/
user-profiles/
order-items/
```

### 2.2 æ–‡ä»¶å‘½å
- **æ§åˆ¶å™¨**: `å¤æ•°åè¯ + æ§åˆ¶å™¨ç±»å‹`
```typescript
users-controller.ts
user-profiles-controller.ts
```

- **æœåŠ¡**: `å¤æ•°åè¯ + æœåŠ¡ç±»å‹`  
```typescript
users-service.ts
orders-service.ts
```

- **æ¨¡å‹**: `å•æ•°åè¯ + æ¨¡å‹ç±»å‹`
```typescript
user-model.ts
order-model.ts
```

- **ç±»å‹å®šä¹‰**: `é¢†åŸŸåè¯ + ç±»å‹`
```typescript
user-types.ts
order-types.ts
```

## 3. ä»£ç å…ƒç´ å‘½åè§„èŒƒ

### 3.1 æ¥å£å‘½å (å‰ç¼€ I)
```typescript
// å®ä½“æ¥å£
interface IUser {
  id: string;
  name: string;
  email: string;
}

// æœåŠ¡æ¥å£
interface IUserService {
  createUser(userData: TCreateUserData): Promise<TUserResponse>;
  getUserById(id: string): Promise<TUserDetails>;
}

// ä»“åº“æ¥å£
interface IUserRepository {
  findById(id: string): Promise<IUser | null>;
  save(user: IUser): Promise<IUser>;
}
```

### 3.2 ç±»å‹åˆ«åå‘½å (å‰ç¼€ T)
```typescript
// è¯·æ±‚æ•°æ®ç±»å‹
type TCreateUserRequest = {
  name: string;
  email: string;
  password: string;
};

// å“åº”æ•°æ®ç±»å‹
type TUserResponse = {
  id: string;
  name: string;
  email: string;
  createdAt: Date;
};

// æŸ¥è¯¢å‚æ•°ç±»å‹
type TUserQueryParams = {
  page?: number;
  limit?: number;
  search?: string;
  sortBy?: string;
};
```

### 3.3 æšä¸¾å‘½å (å‰ç¼€ N)
```typescript
// çŠ¶æ€æšä¸¾
enum NUserStatus {
  Active = 'active',
  Inactive = 'inactive',
  Suspended = 'suspended'
}

// è§’è‰²æšä¸¾
enum NUserRole {
  Admin = 'admin',
  User = 'user',
  Moderator = 'moderator'
}

// é”™è¯¯ç æšä¸¾
enum NErrorCode {
  NotFound = 404,
  ValidationError = 422,
  InternalError = 500
}
```

### 3.4 ç±»å‘½å
```typescript
// æ§åˆ¶å™¨ç±»
class UsersController {
  // ä½¿ç”¨å«è¯­å¥æå‰è¿”å›
  async createUser(request: TCreateUserRequest): Promise<TUserResponse> {
    // å‚æ•°éªŒè¯
    if (!this.isValidUserData(request)) {
      throw new Error('Invalid user data');
    }
    
    // ä¸šåŠ¡é€»è¾‘å§”æ‰˜ç»™æœåŠ¡å±‚
    return await this.userService.createUser(request);
  }
}

// æœåŠ¡ç±»
class UserService implements IUserService {
  // ä½¿ç”¨å¯¹è±¡æ˜ å°„æ›¿ä»£æ¡ä»¶åˆ†æ”¯
  private readonly ROLE_PERMISSIONS = {
    [NUserRole.Admin]: ['read', 'write', 'delete'],
    [NUserRole.User]: ['read'],
    [NUserRole.Moderator]: ['read', 'write']
  };

  async getUserPermissions(role: NUserRole): string[] {
    return this.ROLE_PERMISSIONS[role] ?? [];
  }
}

// æ¨¡å‹ç±»
class UserModel implements IUser {
  constructor(
    public id: string,
    public name: string,
    public email: string,
    public status: NUserStatus = NUserStatus.Active
  ) {}
}
```

### 3.5 å‡½æ•°ä¸æ–¹æ³•å‘½å
```typescript
// ä½¿ç”¨åŠ¨è¯+åè¯å½¢å¼ï¼Œæ¸…æ™°è¡¨è¾¾æ„å›¾
class OrderService {
  // æ•°æ®æŸ¥è¯¢
  async findOrdersByUserId(userId: string): Promise<TOrder[]> {
    return this.orderRepository.findByUserId(userId);
  }

  // æ•°æ®åˆ›å»º
  async createOrderFromCart(cartData: TCartData): Promise<TOrder> {
    // ä½¿ç”¨å¯é€‰é“¾ç®€åŒ–å¯¹è±¡è®¿é—®
    const totalAmount = cartData.items?.reduce((sum, item) => 
      sum + (item.price ?? 0) * (item.quantity ?? 0), 0
    ) ?? 0;

    return this.orderRepository.create({ ...cartData, totalAmount });
  }

  // çŠ¶æ€æ›´æ–°
  async updateOrderStatus(orderId: string, status: NOrderStatus): Promise<boolean> {
    const result = await this.orderRepository.updateStatus(orderId, status);
    return result.affectedRows > 0;
  }
}
```

### 3.6 å˜é‡å‘½å
```typescript
// ä½¿ç”¨æœ‰æ„ä¹‰çš„åç§°ï¼Œé¿å…ç¼©å†™
class ProductController {
  async getProductsWithInventory() {
    // ä½¿ç”¨æè¿°æ€§å˜é‡å
    const availableProducts = await this.productService
      .findAll()
      .then(products => products
        .map(product => ({
          ...product,
          // ä½¿ç”¨å¯é€‰é“¾å’Œç©ºå€¼åˆå¹¶
          inStock: (product.inventory?.quantity ?? 0) > 0
        }))
        .filter(product => product.inStock)
      );

    return availableProducts;
  }
}
```

## 4. ä»£ç ç»„ç»‡è§„èŒƒ

### 4.1 å¯¼å…¥å¯¼å‡ºè§„èŒƒ
```typescript
// ç±»å‹å¯¼å…¥ï¼ˆåˆ†ç»„æ¸…æ™°ï¼‰
import { 
  IUserService, 
  IUserRepository 
} from '../interfaces/';
import { 
  TUserResponse, 
  TCreateUserRequest 
} from '../types/user-types';
import { 
  NUserStatus, 
  NUserRole 
} from '../enums/user-enums';

// å·¥å…·å‡½æ•°å¯¼å…¥
import { 
  validateEmail, 
  generateHash 
} from '../../utils/validation-utils';

// é»˜è®¤å¯¼å‡ºï¼ˆç”¨äºä¸»è¦ç»„ä»¶ï¼‰
export default class UserController {
  // ...
}

// å‘½åå¯¼å‡ºï¼ˆç”¨äºå·¥å…·å‡½æ•°ã€ç±»å‹ç­‰ï¼‰
export { TUserResponse, TCreateUserRequest };
export { USER_VALIDATION_RULES } from './validation-rules';
```

### 4.2 å¼‚æ­¥å¤„ç†è§„èŒƒ
```typescript
class ApiService {
  // ä½¿ç”¨ Promise.all è¿›è¡Œå¹¶è¡Œæ“ä½œ
  async getUserDashboard(userId: string): Promise<TDashboard> {
    try {
      const [user, orders, notifications] = await Promise.all([
        this.userService.findUserById(userId),
        this.orderService.findOrdersByUserId(userId),
        this.notificationService.getUserNotifications(userId)
      ]);

      // ä½¿ç”¨å«è¯­å¥å¤„ç†è¾¹ç•Œæƒ…å†µ
      if (!user) {
        throw new Error('User not found');
      }

      return { user, orders, notifications };
    } catch (error) {
      // ç²¾ç»†é”™è¯¯å¤„ç†
      if (error instanceof NetworkError) {
        this.logger.error('Network error in dashboard service', error);
        throw new Error('Service temporarily unavailable');
      }
      throw error;
    } finally {
      // ä½¿ç”¨ finally è¿›è¡Œæ¸…ç†
      this.cleanupDashboardRequest(userId);
    }
  }

  // å¤§é‡æ•°æ®åˆ†æ‰¹å¤„ç†
  async processBulkUsers(userIds: string[]): Promise<TProcessResult[]> {
    const batchSize = 50;
    const batches = [];

    for (let i = 0; i < userIds.length; i += batchSize) {
      const batch = userIds.slice(i, i + batchSize);
      batches.push(
        Promise.allSettled(
          batch.map(userId => this.processSingleUser(userId))
        )
      );
    }

    const results = await Promise.all(batches);
    return results.flat();
  }
}
```

## 5. è®¾è®¡åŸåˆ™åº”ç”¨

### 5.1 SOLID åŸåˆ™å®ç°
```typescript
// å•ä¸€èŒè´£åŸåˆ™
class UserValidationService {
  // åªè´Ÿè´£ç”¨æˆ·æ•°æ®éªŒè¯
  validateUserData(userData: TCreateUserRequest): TValidationResult {
    const errors: string[] = [];
    
    // ä½¿ç”¨å«è¯­å¥æå‰è¿”å›
    if (!userData.email?.includes('@')) {
      errors.push('Invalid email format');
    }
    
    if ((userData.password?.length ?? 0) < 8) {
      errors.push('Password must be at least 8 characters');
    }
    
    return {
      isValid: errors.length === 0,
      errors
    };
  }
}

// å¼€é—­åŸåˆ™ - å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­
abstract class NotificationService {
  abstract send(message: string): Promise<boolean>;
}

class EmailNotificationService extends NotificationService {
  async send(message: string): Promise<boolean> {
    // é‚®ä»¶å‘é€å®ç°
    return true;
  }
}

class SmsNotificationService extends NotificationService {
  async send(message: string): Promise<boolean> {
    // çŸ­ä¿¡å‘é€å®ç°
    return true;
  }
}
```

### 5.2 DRY åŸåˆ™ - å·¥å…·å‡½æ•°æŠ½è±¡
```typescript
// utils/response-utils.ts
export const buildSuccessResponse = <T>(
  data: T, 
  message: string = 'Success'
): TApiResponse<T> => ({
  success: true,
  data,
  message,
  timestamp: new Date()
});

export const buildErrorResponse = (
  error: string, 
  code: NErrorCode = NErrorCode.InternalError
): TApiResponse<null> => ({
  success: false,
  data: null,
  error,
  code,
  timestamp: new Date()
});
```

## 6. è´¨é‡ä¿è¯è§„èŒƒ

### 6.1 ä»£ç æäº¤æ£€æŸ¥æ¸…å•
- âœ… æ¥å£å‘½åä»¥ `I` å‰ç¼€å¼€å¤´
- âœ… ç±»å‹åˆ«åä»¥ `T` å‰ç¼€å¼€å¤´  
- âœ… æšä¸¾ä»¥ `N` å‰ç¼€å¼€å¤´
- âœ… æ–‡ä»¶ä½¿ç”¨å¤æ•°å½¢å¼å‘½å
- âœ… æ¡ä»¶é€»è¾‘åµŒå¥—ä¸è¶…è¿‡ 2 å±‚
- âœ… å¤šåˆ†æ”¯åœºæ™¯ä½¿ç”¨å¯¹è±¡æ˜ å°„/Map
- âœ… é“¾å¼å–å€¼ä½¿ç”¨å¯é€‰é“¾ `?.`
- âœ… æ¶‰åŠ `this` çš„å‡½æ•°æœªä½¿ç”¨ç®­å¤´å‡½æ•°
- âœ… å¼‚æ­¥æ“ä½œæ­£ç¡®ä½¿ç”¨ Promise ç»„åˆæ–¹æ³•
- âœ… å¤§é‡ä»»åŠ¡é‡‡ç”¨æ‰¹å¤„ç†/æ± åŒ–æŠ€æœ¯
- âœ… é”™è¯¯å¤„ç†åŒ…å« `finally` ä¿åº•æ“ä½œ
- âœ… é¡ºåºæ‰§è¡Œä½¿ç”¨ `for...of + await`

## 7. Commit ä¿¡æ¯è§„èŒƒ

ä¸ºä¿è¯ä»£ç æäº¤å†å²æ¸…æ™°å¯è¿½æº¯ï¼Œä¾¿äºååŒå¼€å‘å’Œç‰ˆæœ¬ç®¡ç†ï¼Œæ¨èé‡‡ç”¨ **Conventional Commits è§„èŒƒ** ä½œä¸º commit message çš„æ ¼å¼æ ‡å‡†ã€‚


### 7.1 åŸºæœ¬æ ¼å¼
commit message éœ€éµå¾ªä»¥ä¸‹ç»“æ„ï¼š
```
<ç±»å‹>[å¯é€‰ä½œç”¨åŸŸ]: <æè¿°>

[å¯é€‰æ­£æ–‡]

[å¯é€‰è„šæ³¨]
```


### 7.2 å„éƒ¨åˆ†è¯´æ˜

#### 7.2.1 ç±»å‹ï¼ˆTypeï¼‰
ç”¨äºè¯´æ˜ commit çš„æ€§è´¨ï¼Œå¿…é¡»ä¸ºä»¥ä¸‹å€¼ä¹‹ä¸€ï¼š
- `feat`ï¼šæ–°å¢åŠŸèƒ½ï¼ˆå¦‚æ–°å¢ API æ¥å£ã€æ–°å¢æœåŠ¡æ–¹æ³•ï¼‰
- `fix`ï¼šä¿®å¤ bugï¼ˆå¦‚ä¿®å¤æ§åˆ¶å™¨é€»è¾‘é”™è¯¯ã€ä¿®å¤æœåŠ¡å±‚å¼‚å¸¸å¤„ç†ï¼‰
- `docs`ï¼šæ–‡æ¡£å˜æ›´ï¼ˆå¦‚æ›´æ–°å¼€å‘è§„èŒƒã€è¡¥å……æ¥å£æ³¨é‡Šï¼‰
- `style`ï¼šä»£ç æ ¼å¼è°ƒæ•´ï¼ˆä¸å½±å“ä»£ç é€»è¾‘ï¼Œå¦‚ç¼©è¿›ã€å˜é‡å‘½åæ ¼å¼ä¿®æ­£ï¼‰
- `refactor`ï¼šä»£ç é‡æ„ï¼ˆæ—¢éæ–°å¢åŠŸèƒ½ä¹Ÿéä¿®å¤ bugï¼Œå¦‚ä¼˜åŒ–æœåŠ¡å±‚ç®—æ³•ã€è°ƒæ•´æ§åˆ¶å™¨å‚æ•°æ ¡éªŒé€»è¾‘ï¼‰
- `perf`ï¼šæ€§èƒ½ä¼˜åŒ–ï¼ˆå¦‚æå‡æ•°æ®åº“æŸ¥è¯¢æ•ˆç‡ã€å‡å°‘æ¥å£å“åº”æ—¶é—´ï¼‰
- `test`ï¼šæ–°å¢æˆ–ä¿®æ”¹æµ‹è¯•ä»£ç ï¼ˆå¦‚ä¸ºæœåŠ¡å±‚æ·»åŠ å•å…ƒæµ‹è¯•ã€è¡¥å……æ§åˆ¶å™¨é›†æˆæµ‹è¯•ï¼‰
- `build`ï¼šæ„å»ºé…ç½®å˜æ›´ï¼ˆå¦‚ä¿®æ”¹æ‰“åŒ…é…ç½®ã€ä¾èµ–ç‰ˆæœ¬æ›´æ–°ï¼‰
- `ci`ï¼šæŒç»­é›†æˆé…ç½®å˜æ›´ï¼ˆå¦‚è°ƒæ•´ GitHub Actions å·¥ä½œæµã€ä¿®æ”¹ Jenkins è„šæœ¬ï¼‰
- `chore`ï¼šå…¶ä»–ä¸å½±å“ä»£ç é€»è¾‘çš„å˜æ›´ï¼ˆå¦‚åˆ é™¤å†—ä½™æ–‡ä»¶ã€è°ƒæ•´ç›®å½•ç»“æ„ï¼‰


#### 7.2.2 ä½œç”¨åŸŸï¼ˆScopeï¼‰
å¯é€‰ï¼Œç”¨äºæŒ‡å®š commit å½±å“çš„æ¨¡å—ï¼Œå»ºè®®ä¸é¡¹ç›®ç›®å½•ç»“æ„å¯¹åº”ï¼Œä¾‹å¦‚ï¼š
- `controllers`ï¼šæ§åˆ¶å™¨å±‚
- `services`ï¼šæœåŠ¡å±‚
- `models`ï¼šæ¨¡å‹å±‚
- `repositories`ï¼šæ•°æ®è®¿é—®å±‚
- `routers`ï¼šè·¯ç”±å±‚
- `types`ï¼šç±»å‹å®šä¹‰
- `enums`ï¼šæšä¸¾å®šä¹‰
- `utils`ï¼šå·¥å…·å‡½æ•°
- `config`ï¼šé…ç½®æ–‡ä»¶


#### 7.2.3 æè¿°ï¼ˆDescriptionï¼‰
- ç®€æ´æè¿° commit çš„æ ¸å¿ƒå†…å®¹ï¼ˆä¸è¶…è¿‡ 50 å­—ç¬¦ï¼‰
- ä½¿ç”¨ç°åœ¨æ—¶ï¼ˆå¦‚â€œaddâ€è€Œéâ€œaddedâ€ï¼‰
- é¦–å­—æ¯å°å†™ï¼Œç»“å°¾ä¸åŠ å¥å·


#### 7.2.4 æ­£æ–‡ï¼ˆBodyï¼‰
å¯é€‰ï¼Œè¯¦ç»†è¯´æ˜ commit çš„èƒŒæ™¯ã€ä¿®æ”¹åŸå› å’Œå…·ä½“å†…å®¹ï¼Œå¯æ¢è¡Œã€‚


#### 7.2.5 è„šæ³¨ï¼ˆFooterï¼‰
å¯é€‰ï¼Œç”¨äºæ ‡è®°ç ´åæ€§å˜æ›´æˆ–å…³é—­ issuesï¼š
- ç ´åæ€§å˜æ›´ï¼šä»¥ `BREAKING CHANGE:` å¼€å¤´ï¼Œè¯´æ˜å˜æ›´å†…å®¹åŠè¿ç§»æ–¹æ³•
- å…³é—­ issuesï¼šä½¿ç”¨ `Closes #123` æˆ– `Fixes #456` æ ¼å¼å…³è” issue ç¼–å·


### 7.3 ç¤ºä¾‹
```
feat(controllers): add user profile update API

- æ–°å¢ PATCH /users/:id/profile æ¥å£
- æ”¯æŒæ›´æ–°ç”¨æˆ·æ˜µç§°ã€å¤´åƒç­‰éæ•æ„Ÿä¿¡æ¯
- ä¾èµ– user-service çš„ updateProfile æ–¹æ³•

Closes #789
```

```
fix(services): fix order status update logic in OrderService

ä¿®å¤è®¢å•çŠ¶æ€æ›´æ–°æ—¶æœªæ ¡éªŒæƒé™çš„é—®é¢˜ï¼Œç°åœ¨ä¼šå…ˆé€šè¿‡ UserService éªŒè¯æ“ä½œäººè§’è‰²

BREAKING CHANGE: OrderService.updateStatus æ–¹æ³•ä¸å†æ¥å— rawStatus å‚æ•°ï¼Œéœ€ä¼ å…¥ NOrderStatus æšä¸¾å€¼
```

```
refactor(models): simplify UserModel constructor

ç§»é™¤å†—ä½™çš„é»˜è®¤å€¼è®¾ç½®ï¼Œæ”¹ç”¨å‚æ•°é»˜è®¤å€¼ç®€åŒ–ä»£ç 
```


### 7.4 ååŒå¼€å‘çº¦æŸå·¥å…·
ä¸ºç¡®ä¿å›¢é˜Ÿæˆå‘˜éµå®ˆ commit è§„èŒƒï¼Œæ¨èé…ç½® **commitlint** è¿›è¡Œè‡ªåŠ¨æ£€æŸ¥ï¼š

#### 7.4.1 å®‰è£…ä¾èµ–
```bash
npm install --save-dev @commitlint/cli @commitlint/config-conventional husky
```

#### 7.4.2 é…ç½® commitlint
åˆ›å»º `commitlint.config.js` æ–‡ä»¶ï¼š
```javascript
module.exports = {
  extends: ['@commitlint/config-conventional']
};
```

#### 7.4.3 é…ç½® husky é’©å­
åœ¨ `package.json` ä¸­æ·»åŠ ï¼š
```json
{
  "husky": {
    "hooks": {
      "commit-msg": "commitlint -E HUSKY_GIT_PARAMS"
    }
  }
}
```

#### 7.4.4 ç”Ÿæ•ˆé…ç½®
```bash
npx husky install
npx husky add .husky/commit-msg 'npx --no -- commitlint --edit $1'
```

é…ç½®å®Œæˆåï¼Œä¸ç¬¦åˆè§„èŒƒçš„ commit ä¼šè¢«æ‹¦æˆªï¼Œç¡®ä¿æäº¤å†å²çš„ä¸€è‡´æ€§ã€‚